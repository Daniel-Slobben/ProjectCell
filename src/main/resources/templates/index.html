<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HTMX Canvas Grid</title>
    <script src="https://unpkg.com/htmx.org@1.9.5"></script>
    <style>
        canvas {
            border: 1px solid #ccc;
            image-rendering: pixelated; /* Ensures crisp edges */
        }
    </style>
</head>
<body>

<h1>HTMX Canvas Grid</h1>
<canvas id="gridCanvas"></canvas>

<script>
    const canvas = document.getElementById("gridCanvas");
    const ctx = canvas.getContext("2d");

    const cellSize = 10; // Each cell is 10x10 pixels
    let size = 500;
    let x  = 100;
    let y = 100;

    canvas.width = size * cellSize;
    canvas.height = size * cellSize;

    // Fetch grid state from backend
    function fetchGrid() {
        fetch(`/state/${x}/${y}/${size}`) // Expect JSON response
            .then(response => response.json())
            .then(data => drawGrid(data.state)) // Read "state" array
            .catch(err => console.error("Error fetching grid:", err));
    }

    // Draw the grid using the `CellState` enum
    function drawGrid(gridData) {
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        for (let y = 0; y < size; y++) {
            for (let x = 0; x < size; x++) {
                const cell = gridData[x][y]; // Extract cell object
                const state = cell.cellState; // Get state as string

                if (state === "ALIVE") ctx.fillStyle = "black";
                else if (state === "DEAD") ctx.fillStyle = "white";
                else ctx.fillStyle = "gray"; // EMPTY

                ctx.fillRect(x * cellSize, y * cellSize, cellSize, cellSize);
                ctx.strokeStyle = "#ccc";
                ctx.strokeRect(x * cellSize, y * cellSize, cellSize, cellSize);
            }
        }
    }

    // Handle click event for updating a cell
    canvas.addEventListener("click", function(event) {
        const x = Math.floor(event.offsetX / cellSize);
        const y = Math.floor(event.offsetY / cellSize);

        fetch(`/cell/${x}/${y}/toggle`, { method: "PUT" }) // Toggle state
            .then(() => fetchGrid()); // Refresh grid after change
    });

    setInterval(fetchGrid, 3000);
    fetchGrid(); // Initial load
</script>

</body>
</html>